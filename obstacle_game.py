import streamlit as st
import random
import json
from PIL import Image
import speech_recognition as sr
import pygame
from gtts import gTTS
import os

# C·∫•u h√¨nh giao di·ªán
st.set_page_config(page_title="Tr√≤ Ch∆°i V∆∞·ª£t Qua Ch∆∞·ªõng Ng·∫°i V·∫≠t", page_icon="üèÉ", layout="centered")


def load_questions():
    with open("data/test.json", "r", encoding="utf-8") as f:
        return json.load(f)


def text_to_speech(text, filename="temp_speech.mp3", language='vi'):
    """Chuy·ªÉn vƒÉn b·∫£n th√†nh gi·ªçng n√≥i v√† ph√°t"""
    try:
        # X√≥a file c≈© n·∫øu t·ªìn t·∫°i
        if os.path.exists(filename):
            try:
                os.remove(filename)
            except PermissionError:
                print("Kh√¥ng th·ªÉ x√≥a file c≈©")
                return False

        # T·∫°o file √¢m thanh m·ªõi
        tts = gTTS(text=text, lang=language, slow=False)
        tts.save(filename)

        # Ph√°t √¢m thanh
        pygame.mixer.init()
        pygame.mixer.music.load(filename)
        pygame.mixer.music.play()

        # Ch·ªù ph√°t xong
        while pygame.mixer.music.get_busy():
            pygame.time.Clock().tick(10)

        return True
    except Exception as e:
        st.error(f"L·ªói trong text_to_speech: {str(e)}")
        return False


# CSS giao di·ªán
st.markdown("""
<style>
    .title {
        font-size: 40px;
        font-weight: bold;
        text-align: center;
        color: #388E3C;
        margin-bottom: 20px;
    }
    .track {
        font-size: 24px;
        line-height: 1.5;
        margin: 20px 0;
    }
    .question-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .question-text {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
    }
    .answer-btn {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        font-size: 16px;
        text-align: left;
        border-radius: 8px;
        transition: all 0.3s;
    }
    .answer-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .key-hint {
        font-size: 14px;
        color: #666;
        margin-top: 25px;
        padding: 10px;
        background-color: #e8f4f8;
        border-radius: 8px;
    }
    .score-display {
        font-size: 18px;
        font-weight: bold;
        color: #e74c3c;
        margin-bottom: 15px;
    }
    .image-container {
        margin: 15px auto;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-width: 100%;
        text-align: center;
    }
    .question-image {
        max-width: 100%;
        max-height: 300px;
        margin: 0 auto;
        display: block;
        border-radius: 8px;
        object-fit: contain;
        cursor: pointer;
    }
    .explanation {
        margin-top: 15px;
        padding: 10px;
        background-color: #f0f8ff;
        border-radius: 8px;
        font-size: 16px;
    }
</style>
""", unsafe_allow_html=True)

# Hi·ªÉn th·ªã ti√™u ƒë·ªÅ
st.markdown("<p class='title'>üèÉ‚Äç‚ôÇÔ∏è Tr√≤ Ch∆°i V∆∞·ª£t Qua Ch∆∞·ªõng Ng·∫°i V·∫≠t üèÉ‚Äç‚ôÄÔ∏è</p>", unsafe_allow_html=True)

# Kh·ªüi t·∫°o tr·∫°ng th√°i tr√≤ ch∆°i
if "game_state" not in st.session_state:
    questions = load_questions()
    random.shuffle(questions)

    st.session_state.game_state = {
        "player_pos": 0,
        "current_question": 0,
        "finished": False,
        "score": 0,
        "questions": questions,
        "selected_answer": None,
        "show_result": False,
        "focused_button": 0,
        "read_question": False,
        "answer_submitted": False  # Th√™m tr·∫°ng th√°i ƒë·ªÉ ki·ªÉm tra ƒë√£ ch·ªçn ƒë√°p √°n ch∆∞a
    }


def reset_game():
    questions = load_questions()
    random.shuffle(questions)

    st.session_state.game_state = {
        "player_pos": 0,
        "current_question": 0,
        "finished": False,
        "score": 0,
        "questions": questions,
        "selected_answer": None,
        "show_result": False,
        "focused_button": 0,
        "read_question": False,
        "answer_submitted": False
    }


def check_answer(selected_option):
    game_state = st.session_state.game_state
    q = game_state["questions"][game_state["current_question"]]

    selected_char = chr(65 + selected_option)

    if selected_char == q["dap_an_dung"]:
        game_state["player_pos"] = min(10, game_state["player_pos"] + 1)
        game_state["score"] += 1
        game_state["show_result"] = True
        game_state["result_message"] = "‚úÖ ƒê√∫ng r·ªìi! B·∫°n ti·∫øn l√™n 1 b∆∞·ªõc."
    else:
        game_state["player_pos"] = max(0, game_state["player_pos"] - 1)
        game_state["show_result"] = True
        game_state["result_message"] = f"‚ùå Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: {q['dap_an_dung']}"

    game_state["current_question"] += 1
    game_state["selected_answer"] = None
    game_state["focused_button"] = 0
    game_state["read_question"] = False
    game_state["answer_submitted"] = True  # ƒê√°nh d·∫•u ƒë√£ ch·ªçn ƒë√°p √°n

    if game_state["player_pos"] == 10:
        game_state["finished"] = True
        game_state["result_message"] = "üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ v·ªÅ ƒë√≠ch!"


def read_current_question():
    game_state = st.session_state.game_state
    if not game_state["finished"] and game_state["current_question"] < len(game_state["questions"]):
        q = game_state["questions"][game_state["current_question"]]
        question_text = f"C√¢u {game_state['current_question'] + 1}: {q['cau_hoi']}"
        options = " ".join([f"ƒê√°p √°n {chr(65 + i)}: {option}." for i, option in enumerate(q['dap_an'])])
        full_text = f"{question_text} {options}"
        text_to_speech(full_text)
        game_state["read_question"] = True


def read_explanation():
    game_state = st.session_state.game_state
    if not game_state["finished"] and game_state["current_question"] < len(game_state["questions"]):
        q = game_state["questions"][game_state["current_question"]]
        if "giai_thich" in q and q["giai_thich"] and game_state["answer_submitted"]:
            text_to_speech(f"Gi·∫£i th√≠ch: {q['giai_thich']}")


# JavaScript ƒë·ªÉ x·ª≠ l√Ω ph√≠m t·∫Øt
keyboard_js = """
<script>
document.addEventListener('keydown', function(event) {
    if (['1','2','3','4','r','s'].includes(event.key.toLowerCase())) {
        Streamlit.setComponentValue(event.key);
    }
});
</script>
"""

key_event = st.components.v1.html(keyboard_js, height=0)

# X·ª≠ l√Ω ph√≠m b·∫•m
if hasattr(key_event, '_result') and key_event._result is not None:
    key = key_event._result

    if key == 'r':
        reset_game()
        st.rerun()
    elif key == 's':
        read_current_question()
        st.rerun()
    elif key in ['1', '2', '3', '4']:
        selected = int(key) - 1
        st.session_state.game_state["selected_answer"] = selected
        check_answer(selected)
        st.rerun()

# Hi·ªÉn th·ªã tr√≤ ch∆°i
game_state = st.session_state.game_state

# Hi·ªÉn th·ªã ƒëi·ªÉm s·ªë v√† ƒë∆∞·ªùng ƒëua
st.markdown(f'<div class="score-display">ƒêi·ªÉm s·ªë: {game_state["score"]}</div>', unsafe_allow_html=True)
line = ["üü©"] * 11
line[game_state["player_pos"]] = "üßç"
line[10] = "üèÅ"
st.markdown(f'<div class="track">{"".join(line)}</div>', unsafe_allow_html=True)

# Hi·ªÉn th·ªã k·∫øt qu·∫£
if game_state.get("show_result", False):
    if game_state["finished"]:
        st.success(game_state["result_message"])
    else:
        if "‚úÖ" in game_state["result_message"]:
            st.success(game_state["result_message"])
        else:
            st.error(game_state["result_message"])

# Hi·ªÉn th·ªã c√¢u h·ªèi
if not game_state["finished"] and game_state["current_question"] < len(game_state["questions"]):
    q = game_state["questions"][game_state["current_question"]]

    with st.container():
        st.markdown('<div class="question-container">', unsafe_allow_html=True)

        # Hi·ªÉn th·ªã h√¨nh ·∫£nh n·∫øu c√≥
        if "hinh_anh" in q and q["hinh_anh"]:
            try:
                image = Image.open(q['hinh_anh'])
                st.markdown('<div class="image-container">', unsafe_allow_html=True)

                # T·∫°o m·ªôt n√∫t ·∫©n ƒë·ªÉ x·ª≠ l√Ω click v√†o h√¨nh ·∫£nh
                if st.button("", key=f"image_btn_{game_state['current_question']}"):
                    read_explanation()

                st.image(image, use_container_width =True,
                         caption="Nh·∫•n v√†o h√¨nh ƒë·ªÉ nghe gi·∫£i th√≠ch" if (
                                     "giai_thich" in q and game_state["answer_submitted"]) else "")
                st.markdown('</div>', unsafe_allow_html=True)
            except Exception as e:
                st.warning(f"Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh: {str(e)}")

        st.markdown(f'<div class="question-text">C√¢u {game_state["current_question"] + 1}: {q["cau_hoi"]}</div>',
                    unsafe_allow_html=True)

        # N√∫t ƒë·ªçc c√¢u h·ªèi
        if st.button("üîä ƒê·ªçc c√¢u h·ªèi", key=f"read_question_{game_state['current_question']}"):
            read_current_question()

        # Hi·ªÉn th·ªã c√°c l·ª±a ch·ªçn
        cols = st.columns(2)
        for i, option in enumerate(q["dap_an"]):
            with cols[i % 2]:
                if st.button(
                        f"{chr(65 + i)}. {option}",
                        key=f"answer_{game_state['current_question']}_{i}",
                        on_click=check_answer,
                        args=(i,),
                        type="primary" if game_state["selected_answer"] == i else "secondary"
                ):
                    game_state["selected_answer"] = i

        # Hi·ªÉn th·ªã gi·∫£i th√≠ch n·∫øu c√≥ v√† ƒë√£ ch·ªçn ƒë√°p √°n
        if "giai_thich" in q and q["giai_thich"] and game_state["answer_submitted"]:
            st.markdown(f'<div class="explanation"><b>Gi·∫£i th√≠ch:</b> {q["giai_thich"]}</div>',
                        unsafe_allow_html=True)

            # N√∫t ƒë·ªçc gi·∫£i th√≠ch
            if st.button("üîä ƒê·ªçc gi·∫£i th√≠ch", key=f"read_explanation_{game_state['current_question']}"):
                read_explanation()

        st.markdown('</div>', unsafe_allow_html=True)

# Hi·ªÉn th·ªã khi k·∫øt th√∫c
elif game_state["finished"]:
    st.balloons()
    st.success(f"üèÅ B·∫°n ƒë√£ v·ªÅ ƒë√≠ch v·ªõi s·ªë ƒëi·ªÉm: {game_state['score']}/{len(game_state['questions'])}")
else:
    st.warning(f"‚õî H·∫øt c√¢u h·ªèi! B·∫°n d·ª´ng ·ªü v·ªã tr√≠: {game_state['player_pos']}")

# H∆∞·ªõng d·∫´n v√† n√∫t ch∆°i l·∫°i
st.markdown("""
<div class="key-hint">
<b>H∆∞·ªõng d·∫´n:</b><br>
‚Ä¢ Nh·∫•n <b>1-4</b> ƒë·ªÉ ch·ªçn ƒë√°p √°n t∆∞∆°ng ·ª©ng (1=A, 2=B, 3=C, 4=D)<br>
‚Ä¢ Nh·∫•n <b>S</b> ƒë·ªÉ nghe ƒë·ªçc c√¢u h·ªèi v√† ƒë√°p √°n<br>
‚Ä¢ Nh·∫•n <b>R</b> ƒë·ªÉ ch∆°i l·∫°i t·ª´ ƒë·∫ßu<br>
‚Ä¢ Nh·∫•n v√†o h√¨nh ·∫£nh ƒë·ªÉ nghe gi·∫£i th√≠ch (sau khi ch·ªçn ƒë√°p √°n)<br>
‚Ä¢ Ho·∫∑c nh·∫•n v√†o n√∫t ƒë√°p √°n b·∫±ng chu·ªôt
</div>
""", unsafe_allow_html=True)

if st.button("üîÑ Ch∆°i l·∫°i", key="reset_button"):
    reset_game()
    st.rerun()